The Ray Tracing Routines
************************
The driving routine, which is called by the interface routine
QRT\_TRACE is SRT\_TRACE. Within this routine there are two loops.
The outer loop is definite and works through the NRAYS which are
to be generated by the source.
The inner loop is indefinite and traces each ray through the surface elements.
The next surface in the sequence is determined by the outcome of encounters
with elements and multiple reflections between surfaces are allowed.
This inner loop is terminated when the ray is absorbed, detected or
finally misses the last element in the sequence.

Each surface element type is specified by an index as listed in this table:


==  =======  =======  ==========  ===============  ===========  =========  ====
#   surface  form     deform      limits           single/nest  code       ikon
==  =======  =======  ==========  ===============  ===========  =========  ====
1   plane    open     normal      cartesian        single       plna       1
2   plane    open     normal      radial           single       plna       2
3   plane    open     radial      radial           single       plna       3
4   plane    open     radial      radial           nested       plna       -n
5   plane    closed   normal      cartesian        single       plne       1
6   plane    closed   normal      radial           single       plne       2
7   plane    closed   radial      radial           single       plne       3
8   plane    closed   radial      radial           nested       plne       -n
9   conic    grazing  radial      axial            single       cnic       1
10  conic    normal   axial       radial           single       cnin       1
11  conic    normal   axial       cartesian        single       cnin       2
12  sphere   grazing  radial      cartesian        single       sphr       1
13  sphere   grazing  radial      radial           single       sphr       2
14  sphere   normal   radial      cartesian        single       sphr       3
15  sphere   normal   radial      radial           single       sphr       4
16  conic    normal   azimuthal   cartesian        single       cnin       3
17  plane    open     normal      azimuthal        single       plna       4
18  plane    open     normal      cartesian grid   single       plna       6
19  conic    grazing  radial      axial+azimuthal  single       cnic       2
20  plane    closed   normal      cartesian slat   single       plna       7
21  sphere   pore     normal      pore             multiple     sphr+pore  5
22  plane    open     normal      sector           single       plna       8
23  conic    moa      radial      axial+azimuthal  multiple     cnic       3
24  plane    Sipores  normal      pore             multiple     plna       9
25  plane    KBstack  normal      slots            multiple     plna       9
26  conic    normal   normal      axial+azimuthal  single       cnic       3
27  plane    open     normal      parallelogram    single       plna       10
28  sphere   MPOarr   normal      pore             multiple     sphr+arr   5
29  plane    MPOtest  normal      pore             single       plna       11
30  plane    SPOarr   normal      pore             multiple     plna       9   
31  sphere   Schmidt  normal      slot             multiple     sle        5   
32  plane    Schmidt  normal      slot             multiple     plns       1   
==  =======  =======  ==========  ===============  ===========  =========  ====

Each of these surface types has a subroutine SRT\_SUnn associated with
it where nn is the type index. These routines call 1 of 13 routines which
find the intersection of rays with a plane, sphere, conic, square pores,
MOA slots, Si pores, Si pore array, K-B stack slots or Schmidt lobster stacks.
The pore and slot routines set up the parameters for 4 plane surfaces
which are then serviced by the SRT\_PLNE routine or SRT\_PLNS.
The Si pore routine
sets up the parameters for 8 plane surfaces to define the 1st and
2nd section of the Si pore.

============   ===========================
SRT_PLNA       aperture on plane surface
SRT_PLNE       plane surface
SRT_CNIC       conic at grazing incidence
SRT_CNIN       conic at normal incidence
SRT_SPHR       spherical surface
SRT_PORE       square pore
SRT_MOA        moa slots
SRT_SIPORE     Si pores
SRT_KBS        Kirpatrick-Baez stack
SRT_PLNS       Schmidt version of PLNE
SRT_SLE        Schmidt lobster stack
SRT_SPOARR     Si pores module array
SRT_SQMPOARR   Square pore MPO array
============   ===========================

The combination of form, deformation, limits and single/nested used in each
of these routines is set by the integer argument IKON (see table above).
Full details about
these configurations and the parameters which they use are given in the
comments at the start of the code for each routine.

All the surface element parameters etc. are held in a common area. Individual
surface elements pick up their parameters using an index into this area.
The parameters are set by the following routines:

==============  ===================   ===================================
routine         parameters                      called by
==============  ===================   ===================================
SRT\_SETF       surface               QRT\_MIRROR, QRT\_BAFFLE etc.
SRT\_SETT       surface quality       QRT\_SURFACE, QRT\_LENS, QRT\_PRISM
SRT\_SETD       deformation           QRT\_DEFS
SRT\_SETS       source                QRT\_SOURCE
SRT\_SETCONCOM  SPO constellation     QRT\_SIPORE
SRT\_SETKBSCOM  KBS constellation     QRT\_KBS
SRT\_SETMPOARR  MPO array             QRT\_SQMPOARR
SRT\_SETSLECOM  Schmidt lobster eye   QRT\_SLE
SRT\_SETSPOCOM  Si Pore Optics        QRT\_SPOARR
==============  ===================   ===================================

These routines put the parameters
into common blocks. The order of the parameters is important and must
match the order expected by the target routine. The sequence of
parameters expected is specified in the comment lines at the top
of the surface element routines.
