*+QR_INIT        Initialise/reset the QR environment
        SUBROUTINE QR_INIT()
        IMPLICIT NONE
*ISTAT        in/out        returned status
*-Author Dick Willingale 2012-May-04
        INCLUDE 'QR_COM'
C
        ISTAT=0
C HDS 
        ILOC=0
        IPTR=0
        IHDS=0
C FITS
        IFITS=0
C
        CALL QRI_INIT()
        CALL QRT_INIT() 
        CALL QRX_INIT() 
C
        END
*+QRI_INIT Initialisation for image processing
        SUBROUTINE QRI_INIT()
*-Author Dick Willingale 2012-May-11
        INCLUDE 'QRI_TRANSCOM'
C The following from SLA_EQGAL for 2000 epoch
        DATA CTOG/-0.054875539726D0,-0.873437108010D0,-0.483834985808D0,
     :            +0.494109453312D0,-0.444829589425D0,+0.746982251810D0,
     :            -0.867666135858D0,-0.198076386122D0,+0.455983795705D0/
        DATA GTOC/-0.054875539726D0,+0.494109453312D0,-0.867666135858D0,
     :            -0.873437108010D0,-0.444829589425D0,-0.198076386122D0,
     :            -0.483834985808D0,+0.746982251810D0,+0.455983795705D0/
        DOUBLE PRECISION DAXIS(2),OBLIQECL,DCEL(2),DTOR,T
C
        DTOR=ASIN(1.0D0)/90.D0
C Default is to hide sky transformations although they are initialised
        SKYTRANS=.FALSE.
C Set Ra, Dec and Roll
        DAXIS(1)=0.D0
        DAXIS(2)=0.D0
        QRA=DAXIS(1)
        QDEC=DAXIS(2)
        QROLL=0.D0
        QMJD=45000.0D0
C Obliquity of Ecliptic from SLA_ECMAT
       T=(QMJD-51544.5D0)/36525D0
       OBLIQECL=(84381.448D0+(-46.8150D0+(-0.00059D0+0.001813D0*T)*T)*T)
       OBLIQECL=DTOR*OBLIQECL/3600.D0
       DCEL(1)=0.D0
       DCEL(2)=0.D0
        CALL AX_DMAT(DCEL,OBLIQECL,CTOE,ETOC)
        CALL AX_DMAT(DAXIS,QROLL,CTOS,STOC)
        CALL AX_DONMXM(GTOC,CTOS,GTOS)
        CALL AX_DONMXM(STOC,CTOG,STOG)
        CALL AX_DONMXM(ETOC,CTOS,ETOS)
        CALL AX_DONMXM(STOC,CTOE,STOE)
C Set default pixel sizes etc.
        XYTORAD(1)=-DTOR
        XYTORAD(2)=DTOR
        BLHC(1)=0.0
        BLHC(2)=0.0
        XYPIXEL(1)=DTOR
        XYPIXEL(2)=DTOR
        XYNOW(1)=DCEL(1)
        XYNOW(2)=DCEL(2)
        IPROJ=0
        CALL QRI_LTOS(DCEL,DAXIS)
        AENOW(1)=DAXIS(1)
        AENOW(2)=DAXIS(2)
        END
*+QRT_INIT        Initialise/reset the QRT environment
        SUBROUTINE QRT_INIT()
        IMPLICIT NONE
*-Author Dick Willingale 2012-May-04
        INCLUDE 'SRT_COM'
        INTEGER J
C
        NPAR=0
        NSUR=0
        IDSAM=0
        ITRA=0
        NRAYS=0
        ISRC(1)=0
        ISRC(2)=0
        ISRC(3)=0
        NDET=0
        NPOS=0
        IDET=0
        IDEBUG=0
        DO J=1,MAXST
                ISQP(1,J)=0
        ENDDO
        DO J=1,MAXDF
                IDFM(1,J)=0
        ENDDO
c        write(*,*) 'qpy initialises/reset'
        END
*+QRX_INIT initialise X routines
        SUBROUTINE QRX_INIT()
*-Author Dick Willingale 2014-Apr-08
        include 'SPX_COM'
        data element/'H ','He','Li','Be','B ','C ','N ','O ','F ','Ne',
     +               'Na','Mg','Al','Si','P ','S ','Cl','Ar','K ','Ca',
     +               'Sc','Ti','V ','Cr','Mn','Fe','Co','Ni','Cu','Zn'/
        data abundance/'angr','aspl','feld','aneb','grsa','wilm','lodd'/
        data xsection/'vern'/
        data metalicity/1.0/
        data iabu/6/
        data abund/
     +  1.00e+00,1.00e+00,1.00e+00,1.00e+00,1.00e+00,1.00e+00,1.00e+00,
     +  9.77e-02,8.51e-02,9.77e-02,8.01e-02,8.51e-02,9.77e-02,7.92e-02,
     +  1.45e-11,1.12e-11,1.26e-11,2.19e-09,1.26e-11,0.000000,1.90e-09,
     +  1.41e-11,2.40e-11,2.51e-11,2.87e-11,2.51e-11,0.000000,2.57e-11,
     +  3.98e-10,5.01e-10,3.55e-10,8.82e-10,3.55e-10,0.000000,6.03e-10,
     +  3.63e-04,2.69e-04,3.98e-04,4.45e-04,3.31e-04,2.40e-04,2.45e-04,
     +  1.12e-04,6.76e-05,1.00e-04,9.12e-05,8.32e-05,7.59e-05,6.76e-05,
     +  8.51e-04,4.90e-04,8.51e-04,7.39e-04,6.76e-04,4.90e-04,4.90e-04,
     +  3.63e-08,3.63e-08,3.63e-08,3.10e-08,3.63e-08,0.000000,2.88e-08,
     +  1.23e-04,8.51e-05,1.29e-04,1.38e-04,1.20e-04,8.71e-05,7.41e-05,
     +  2.14e-06,1.74e-06,2.14e-06,2.10e-06,2.14e-06,1.45e-06,1.99e-06,
     +  3.80e-05,3.98e-05,3.80e-05,3.95e-05,3.80e-05,2.51e-05,3.55e-05,
     +  2.95e-06,2.82e-06,2.95e-06,3.12e-06,2.95e-06,2.14e-06,2.88e-06,
     +  3.55e-05,3.24e-05,3.55e-05,3.68e-05,3.35e-05,1.86e-05,3.47e-05,
     +  2.82e-07,2.57e-07,2.82e-07,3.82e-07,2.82e-07,2.63e-07,2.88e-07,
     +  1.62e-05,1.32e-05,1.62e-05,1.89e-05,2.14e-05,1.23e-05,1.55e-05,
     +  1.88e-07,3.16e-07,1.88e-07,1.93e-07,3.16e-07,1.32e-07,1.82e-07,
     +  3.63e-06,2.51e-06,4.47e-06,3.82e-06,2.51e-06,2.57e-06,3.55e-06,
     +  1.32e-07,1.07e-07,1.32e-07,1.39e-07,1.32e-07,0.000000,1.29e-07,
     +  2.29e-06,2.19e-06,2.29e-06,2.25e-06,2.29e-06,1.58e-06,2.19e-06,
     +  1.26e-09,1.41e-09,1.48e-09,1.24e-09,1.48e-09,0.000000,1.17e-09,
     +  9.77e-08,8.91e-08,1.05e-07,8.82e-08,1.05e-07,6.46e-08,8.32e-08,
     +  1.00e-08,8.51e-09,1.00e-08,1.08e-08,1.00e-08,0.000000,1.00e-08,
     +  4.84e-07,4.37e-07,4.84e-07,4.93e-07,4.68e-07,3.24e-07,4.47e-07,
     +  2.45e-07,2.69e-07,2.45e-07,3.50e-07,2.45e-07,2.19e-07,3.16e-07,
     +  4.68e-05,3.16e-05,3.24e-05,3.31e-05,3.16e-05,2.69e-05,2.95e-05,
     +  8.60e-08,9.77e-08,8.60e-08,8.27e-08,8.32e-08,8.32e-08,8.13e-08,
     +  1.78e-06,1.66e-06,1.78e-06,1.81e-06,1.78e-06,1.12e-06,1.66e-06,
     +  1.62e-08,1.55e-08,1.62e-08,1.89e-08,1.62e-08,0.000000,1.82e-08,
     +  3.98e-08,3.63e-08,3.98e-08,4.63e-08,3.98e-08,0.000000,4.27e-08/
        data ElementNames/'H ','He','C ','N ','O ',
     +                    'Ne','Mg','Si','S ','Fe'/
        data iabundset/1/
        data iwarmset/0/
        end 
*+QRI_PTOL        Pixel to local XY coordinate transformation
        SUBROUTINE QRI_PTOL(PIX,XYP)
*PIX        input        PIX position 0 to NX-1, 0 to NY-1
*XYP        outout        local XY position
        IMPLICIT NONE
        DOUBLE PRECISION PIX(2),XYP(2)
*-Author Dick Willingale 2012-May-11
        INCLUDE 'QRI_TRANSCOM'
        INCLUDE 'QR_COM'
C
        IF(ISTAT.NE.0) RETURN
C
        XYP(1)=BLHC(1)+PIX(1)*XYPIXEL(1)
        XYP(2)=BLHC(2)+PIX(2)*XYPIXEL(2)
        END
*+QRI_LTOP        local XY to pixel coordinate transformation
        SUBROUTINE QRI_LTOP(XYP,PIX)
*XYP        input        local XY position
*PIX        output        PIX position 0 to NX-1, 0 to NY-1
        IMPLICIT NONE
        DOUBLE PRECISION PIX(2),XYP(2)
*-Author Dick Willingale 2012-May-11
        INCLUDE 'QRI_TRANSCOM'
        INCLUDE 'QR_COM'
C
        IF(ISTAT.NE.0) RETURN
C
        PIX(1)=(XYP(1)-BLHC(1))/XYPIXEL(1)
        PIX(2)=(XYP(2)-BLHC(2))/XYPIXEL(2)
        END
*+QRI_LTOS        local XY to local radians coordinate transformation
        SUBROUTINE QRI_LTOS(XYP,LOC)
*XYP        input        local XY position
*LOC        output        local position Azimuth,Elevation radians
        IMPLICIT NONE
        DOUBLE PRECISION XYP(2),LOC(2)
*-Author Dick Willingale 2012-May-11
        INCLUDE 'QRI_TRANSCOM'
        INCLUDE 'QR_COM'
        DOUBLE PRECISION PIBY2
        INTEGER STATUS
C
        IF(ISTAT.NE.0) RETURN
C
        PIBY2=ASIN(1.0D0)
        STATUS=0
C
        IF(IPROJ.EQ.0) THEN
                LOC(1)=XYP(1)*XYTORAD(1)
                LOC(2)=XYP(2)*XYTORAD(2)
                IF(ABS(LOC(1)).GT.PIBY2*2.D0.OR.
     +            ABS(LOC(2)).GT.PIBY2) THEN
                    STATUS=1
                ENDIF
        ELSEIF(IPROJ.EQ.1) THEN
                CALL AX_DAMMERINV(XYP(1),XYP(2),LOC(1),LOC(2),STATUS)
        ELSEIF(IPROJ.EQ.2) THEN
                CALL AX_LAMBERTINV(XYP(1),XYP(2),LOC(1),LOC(2),STATUS)
        ENDIF
        IF(STATUS.NE.0) THEN
                LOC(1)=0.0
                LOC(2)=0.0
        ENDIF
        END
*+QRI_STOL        local spherical radians to local XYs coordinate transformation
        SUBROUTINE QRI_STOL(LOC,XYP)
*LOC        input        local position Azimuth,Elevation radians
*XYP        output        local XY position
        IMPLICIT NONE
        DOUBLE PRECISION XYP(2),LOC(2)
*-Author Dick Willingale 2012-May-11
        INCLUDE 'QRI_TRANSCOM'
        INCLUDE 'QR_COM'
C
        IF(ISTAT.NE.0) RETURN
C
        IF(IPROJ.EQ.0) THEN
                XYP(1)=LOC(1)/XYTORAD(1)
                XYP(2)=LOC(2)/XYTORAD(2)
        ELSEIF(IPROJ.EQ.1) THEN
                CALL AX_DAMMER(LOC(1),LOC(2),XYP(1),XYP(2))
        ELSEIF(IPROJ.EQ.2) THEN
                CALL AX_LAMBERT(LOC(1),LOC(2),XYP(1),XYP(2))
        ENDIF
        END
*+QRI_STOC        Local to Celestial coordinate transformation
        SUBROUTINE QRI_STOC(LOC,CEL)
*LOC        input        Local position Azimuth,Elevation radians
*CEL        output        Celestial position RA,DEC radians
        IMPLICIT NONE
        DOUBLE PRECISION CEL(2),LOC(2)
*-Author Dick Willingale 2012-May-11
        INCLUDE 'QRI_TRANSCOM'
        INCLUDE 'QR_COM'
C
        IF(ISTAT.NE.0) RETURN
C
        CALL AX_DONVRT(LOC(1),LOC(2),STOC,CEL(1),CEL(2))
        END
*+QRI_CTOS        Celestial to local coordinate transformation
        SUBROUTINE QRI_CTOS(CEL,LOC)
*CEL        input        Celestial position RA,DEC radians
*LOC        output        Local position Azimuth,Elevation radians
        IMPLICIT NONE
        DOUBLE PRECISION CEL(2),LOC(2)
*-Author Dick Willingale 2012-May-11
        INCLUDE 'QRI_TRANSCOM'
        INCLUDE 'QR_COM'
C
        IF(ISTAT.NE.0) RETURN
C
        CALL AX_DONVRT(CEL(1),CEL(2),CTOS,LOC(1),LOC(2))
        END
*+QRI_CTOE        Celestial to Ecliptic coordinate transformation
        SUBROUTINE QRI_CTOE(CEL,ECL)
*CEL        input        Celestial position RA,DEC radians
*ECL        output        Ecliptic position ECL,ECD radians
        IMPLICIT NONE
        DOUBLE PRECISION CEL(2),ECL(2)
*-Author Dick Willingale 2012-May-11
        INCLUDE 'QRI_TRANSCOM'
        INCLUDE 'QR_COM'
C
        IF(ISTAT.NE.0) RETURN
C
        CALL AX_DONVRT(CEL(1),CEL(2),CTOE,ECL(1),ECL(2))
        END
*+QRI_ETOC        Ecliptic to Celestial coordinate transformation
        SUBROUTINE QRI_ETOC(ECL,CEL)
*ECL        output        Ecliptic position ECL,ECD radians
*CEL        input        Celestial position RA,DEC radians
        IMPLICIT NONE
        DOUBLE PRECISION CEL(2),ECL(2)
*-Author Dick Willingale 2012-May-11
        INCLUDE 'QRI_TRANSCOM'
        INCLUDE 'QR_COM'
C
        IF(ISTAT.NE.0) RETURN
C
        CALL AX_DONVRT(ECL(1),ECL(2),ETOC,CEL(1),CEL(2))
        END
*+QRI_CTOG        Celestial to Galactic coordinate transformation
        SUBROUTINE QRI_CTOG(CEL,GAL)
*CEL        input        Celestial position RA,DEC radians
*GAL        output        Galactic position LII,BII radians
        IMPLICIT NONE
        DOUBLE PRECISION CEL(2),GAL(2)
*-Author Dick Willingale 2012-May-11
        INCLUDE 'QRI_TRANSCOM'
        INCLUDE 'QR_COM'
C
        IF(ISTAT.NE.0) RETURN
C
        CALL AX_DONVRT(CEL(1),CEL(2),CTOG,GAL(1),GAL(2))
        END
*+QRI_GTOC        Galactic to Celestial coordinate transformation
        SUBROUTINE QRI_GTOC(GAL,CEL)
*GAL        output        Galactic position LII,BII radians
*CEL        input        Celestial position RA,DEC radians
        IMPLICIT NONE
        DOUBLE PRECISION CEL(2),GAL(2)
*-Author Dick Willingale 2012-May-11
        INCLUDE 'QRI_TRANSCOM'
        INCLUDE 'QR_COM'
C
        IF(ISTAT.NE.0) RETURN
C
        CALL AX_DONVRT(GAL(1),GAL(2),GTOC,CEL(1),CEL(2))
        END
